{"version":3,"sources":["../../src/server/KombatServerEngine.js"],"names":["KombatServerEngine","io","gameEngine","inputOptions","on","shoot","bind","granade","sideA","sideB","wallNorth","Wall","position","TwoVector","width","height","addObjectToWorld","wallEast","wallSouth","wallWest","walls","forEach","w","wall","socket","kombat","Kombat","playerId","name","max_health","health","ammo_capacity","ammo_loaded","last_shot","throw_power","thrwing_granade","socketId","world","queryObject","instanceType","removeObjectFromWorld","id","speed","liveTimer","bullet","Bullet","direction","ownerId","x","y","velocity","Math","cos","sin","timer","add","destroyObjectById","reloadAmmo","Granade","explode","objects","kombatId","granadeId","clone","explosion","Explosion2","radius","kombats","queryObjects","k","d","sqrt","pow","blood","Blood","ServerEngine"],"mappings":"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","sourcesContent":["import { ServerEngine, TwoVector } from 'lance-gg';\nimport Kombat from '../common/Kombat';\nimport Bullet from '../common/Bullet';\nimport Granade from '../common/Granade';\nimport Wall from '../common/Wall';\nimport Explosion2 from '../common/Explosion2';\nimport Blood from '../common/Blood';\n\nexport default class KombatServerEngine extends ServerEngine {\n\n    constructor(io, gameEngine, inputOptions) {\n        super(io, gameEngine, inputOptions);\n        this.gameEngine.on('shoot', this.shoot.bind(this));\n        this.gameEngine.on('granade', this.granade.bind(this));\n    }\n\n    start() {\n        super.start();\n\n        let sideA = 50;\n        let sideB = 3;\n\n        let wallNorth = new Wall(this.gameEngine, null, { \n            position: new TwoVector(0,0), \n            width: sideA,\n            height: sideB,\n        });\n        this.gameEngine.addObjectToWorld(wallNorth);\n\n        let wallEast = new Wall(this.gameEngine, null, { \n            position: new TwoVector(sideA,0), \n            width: sideB,\n            height: sideA,\n        });\n        this.gameEngine.addObjectToWorld(wallEast);\n\n        let wallSouth = new Wall(this.gameEngine, null, { \n            position: new TwoVector(sideB,sideA), \n            width: sideA,\n            height: sideB,\n        });\n        this.gameEngine.addObjectToWorld(wallSouth);\n\n\n        let wallWest = new Wall(this.gameEngine, null, { \n            position: new TwoVector(0,sideB), \n            width: sideB,\n            height: sideA,\n        });\n        this.gameEngine.addObjectToWorld(wallWest);\n\n\n        let walls = [\n            [8,8,3,9],\n            [32,18,8,3],\n            [25,25,2,2],\n            [42,36,3,9],\n            [12,32,8,3],\n        ];\n\n\n        walls.forEach(w => {\n            let wall = new Wall(this.gameEngine, null, { \n                position: new TwoVector(w[0], w[1]), \n                width: w[2],\n                height: w[3],\n            });\n            this.gameEngine.addObjectToWorld(wall);\n        });\n    }\n\n    onPlayerConnected(socket) {\n        super.onPlayerConnected(socket);\n        let kombat = new Kombat(this.gameEngine, null, { \n            position: new TwoVector(10, 10),\n        });\n        kombat.playerId = socket.playerId;\n        kombat.name = 'Kombat '+socket.playerId;\n        kombat.max_health = 10;\n        kombat.health = 10;\n        kombat.ammo_capacity = 21;\n        kombat.ammo_loaded =  21;\n        kombat.last_shot = 0;\n        kombat.throw_power = 0;\n        kombat.thrwing_granade = false;\n        this.gameEngine.addObjectToWorld(kombat);\n    }\n\n    onPlayerDisconnected(socketId, playerId) {\n        super.onPlayerDisconnected(socketId, playerId);\n        let kombat = this.gameEngine.world.queryObject({ playerId: playerId,  instanceType: Kombat });\n        if (kombat) this.gameEngine.removeObjectFromWorld(kombat.id);\n    }\n\n    shoot(kombat) {\n        if(kombat.ammo_loaded > 0){\n            kombat.ammo_loaded--;\n            let speed = 0.4;\n            let liveTimer = 100; //gameloops\n            let bullet = new Bullet(this.gameEngine, null, { \n                direction: kombat.direction,\n                playerId: kombat.playerId,\n                ownerId: kombat.id,\n                position: new TwoVector(\n                    kombat.position.x + (kombat.width / 4),\n                    kombat.position.y + (kombat.height / 4)\n                ),\n                velocity: new TwoVector(\n                    Math.cos(kombat.direction) * speed ,\n                    Math.sin(kombat.direction) * speed\n                )\n            });\n            this.gameEngine.addObjectToWorld(bullet);\n            this.gameEngine.timer.add(liveTimer, this.destroyObjectById, this, [bullet.id]);\n        }\n        else if(kombat.ammo_loaded === 0 ){\n            kombat.ammo_loaded--;\n            this.gameEngine.timer.add(240, this.reloadAmmo, this, [kombat.id]);\n        }\n        \n    }\n\n    granade(kombat) {\n        let speed = .4 * kombat.throw_power;\n        let granade = new Granade(this.gameEngine, null, { \n            direction: kombat.direction,\n            position: new TwoVector(\n                kombat.position.x + (kombat.width / 4),\n                kombat.position.y + (kombat.height / 4)\n            ),\n             velocity: new TwoVector(\n                Math.cos(kombat.direction) * speed ,\n                Math.sin(kombat.direction) * speed\n            )\n        });\n        kombat.throw_power = 0;\n        granade.playerId = kombat.playerId;\n        this.gameEngine.addObjectToWorld(granade);\n        this.gameEngine.timer.add(100, this.explode, this, [granade.id]);\n    }\n\n    destroyObjectById(id) {\n        if (this.gameEngine.world.objects[id]) {\n            this.gameEngine.removeObjectFromWorld(id);\n        }\n    }\n\n    reloadAmmo(kombatId){\n        let kombat = this.gameEngine.world.queryObject({ id: kombatId, instanceType: Kombat });\n        if(kombat){\n            kombat.ammo_loaded = kombat.ammo_capacity;\n        }\n    }\n\n    explode(granadeId) {\n        let granade = this.gameEngine.world.queryObject({ id: granadeId, instanceType: Granade });\n        if(granade){\n            let position = granade.position.clone();\n            let explosion = new Explosion2(this.gameEngine, null, { \n                position: position\n            });\n            this.destroyObjectById(granadeId);\n            explosion.radius = 10;\n            this.gameEngine.addObjectToWorld(explosion);\n            this.gameEngine.timer.add(150, this.destroyObjectById, this, [explosion.id]);\n            \n            let kombats = this.gameEngine.world.queryObjects({ instanceType: Kombat });\n            kombats.forEach(k=> {\n                let d = Math.sqrt(\n                    Math.pow( k.position.x+k.width/2 - position.x , 2) +  Math.pow( k.position.y+k.height/2 - position.y,2)\n                );\n                if(d <= explosion.radius){\n                    k.health -= 3;\n                    if(d <= explosion.radius/2){\n                       k.health -= 3; \n                    }\n                    if(d <= explosion.radius/4){\n                        k.health -= 3; \n                    }\n                    let blood = new Blood(this.gameEngine, null, { position: k.position.clone() });\n                    if(k.health <= 0){\n                        this.destroyObjectById(k.id);\n                    }\n                    this.gameEngine.addObjectToWorld(blood);\n                    this.gameEngine.timer.add(600, this.destroyObjectById, this, [blood.id]);\n                }\n            });\n        }\n    }\n}\n"],"file":"KombatServerEngine.js"}